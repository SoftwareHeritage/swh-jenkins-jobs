- project:
    name: DDOC
    display-name: swh-docs
    jobs:
      - "{name}"
      - "{name}/publish"
      - "{name}/dev"
      - "{name}/builds"

- job-template:
    name: "{name}/publish"
    description: Build the documentation and publish it
    node: swh-sphinx
    gitlab_project_name: swh/devel/swh-environment
    properties:
      - build-discarder:
          days-to-keep: 90

    triggers:
      - timed: "@midnight"

    scm:
      - git:
          url: "{gitlab_url}/{gitlab_project_name}.git"

    builders:
      - shell: |
          #!/bin/bash
          set -ex

          crudini --del .mrconfig snippets
          crudini --del .mrconfig swh-py-template

          # Don't fetch potentially large debian branches
          sed -i '/swh-docs/!s/git clone/git clone --single-branch/g' .mrconfig

          mr -j 4 -t update
          mr -j 4 -t run sh -c 'git checkout --detach `git describe --abbrev=0 --tags`; git clean -dfx'
          cd swh-docs
          git checkout master
          git clean -dfx
          SPHINXOPTCOLOR='--no-color' tox -e sphinx

    publishers:
      - ssh:
          target: "devel"
          site: "pergamon"
          clean-remote: true
          source: "swh-docs/docs/_build/html/**"
          remove-prefix: "swh-docs/docs/_build/html"
          fail-on-error: true
          verbose: true
      - ssh:
          target: "user"
          site: "pergamon"
          clean-remote: true
          source: "swh-docs/user/_build/html/**"
          remove-prefix: "swh-docs/user/_build/html"
          fail-on-error: true
          verbose: true
      - ssh:
          target: "sysadm"
          site: "pergamon"
          clean-remote: true
          source: "swh-docs/sysadm/_build/html/**"
          remove-prefix: "swh-docs/sysadm/_build/html"
          fail-on-error: true
          verbose: true

- job-template:
    name: "{name}/dev"
    description: Build the documentation from git repos
    node: swh-sphinx
    gitlab_project_name: swh/devel/swh-environment
    properties:
      - build-discarder:
          days-to-keep: 90

    triggers:
      - timed: "H 9-22/2 * * *"

    scm:
      - git:
          url: "{gitlab_url}/{gitlab_project_name}.git"

    builders:
      - shell: |
          #!/bin/bash
          set -ex

          crudini --del .mrconfig snippets
          crudini --del .mrconfig swh-py-template

          # Don't fetch potentially large debian branches
          sed -i '/swh-docs/!s/git clone/git clone --single-branch/g' .mrconfig

          mr -j 4 -t update
          mr -t run sh -c 'echo -n "`basename $PWD` " && git describe' | grep -v 'mr run' > revisions.txt
          cd swh-docs
          git clean -dfx
          SPHINXOPTS='-W -q --keep-going -w errors.log' SPHINXOPTCOLOR='--no-color' tox -e sphinx-dev

    publishers:
      - archive:
          artifacts: "revisions.txt,swh-docs/docs/errors.log,swh-docs/.tox/log/*"
      - html-publisher:
          name: "SWH Documentation (HEAD)"
          dir: "swh-docs/docs/_build/html"
          files: "index.html"
          keep-all: false
          includes: "**/*"
      - html-publisher:
          name: "SWH User Documentation (HEAD)"
          dir: "swh-docs/user/_build/html"
          files: "index.html"
          keep-all: false
          includes: "**/*"
      - html-publisher:
          name: "SWH sysadmin Documentation (HEAD)"
          dir: "swh-docs/sysadm/_build/html"
          files: "index.html"
          keep-all: false
          includes: "**/*"

- job-template:
    name: "{name}/builds"
    display_name: GitLab builds
    project-type: pipeline
    docker_image: sphinx
    concurrent: true
    sandbox: true
    properties:
      - build-discarder:
          artifact-num-to-keep: 20
          days-to-keep: 90
      - gitlab:
          connection: "{gitlab_connection_name}"
    triggers:
      - gitlab:
          trigger-push: true
          trigger-merge-request: true
          add-ci-message: true
          cancel-pending-builds-on-update: true
          # secret jenkins token is generated when executing tox
          secret-token: !include-raw: jobs/templates/jenkins-token
    dsl: !include-jinja2: templates/swh-docs-pipeline.groovy.j2
