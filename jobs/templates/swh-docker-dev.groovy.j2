pipeline {
  agent {
    label "built-in"
  }

  options {
    timeout(time: 30, unit: 'MINUTES')
    timestamps()
  }

  stages {
    stage('Checkout') {
      steps {
        git url: "{{gitlab_url}}/{{gitlab_project_name}}.git"
      }
    }

    stage('Build Docker images') {
      steps {
        dir('docker') {
          sh 'docker build --pull --no-cache -t swh/stack .'
        }
      }
    }

    stage('Run tests') {
      steps {
        lock('docker-agent-host-port-5080') {
          dir('docker') {
            sh 'tox -- -v'
          }
        }
      }
    }
  }

  post {
    always {
      archiveArtifacts(
        allowEmptyArchive: true,
        artifacts: 'docker/**/*.logs',
      )
    }
  }
}
