- job-template:
    name: swh-{name}/static
    project-type: pipeline
    sandbox: true
    numToKeep: 20

    dsl: |
      def modname = '{name}'.replace('-', '.')
      pipeline {{
      agent {{ label 'swh-tox' }}

      parameters {{
        string(name: 'BRANCH',
               defaultValue: 'master',
               description: 'branch to checkout from the repository')
        }}
      stages {{
        stage('Checkout') {{
          steps {{
            git branch: "${{params.BRANCH}}", url: 'https://forge.softwareheritage.org/source/swh-{name}.git'
          }}
        }}
        stage('Static analysis') {{
          steps {{
            echo "flake8"
            sh '''python3 -m flake8'''

            echo "radon"
            sh  '''
            mkdir -p reports
            python3 -m pip install --user --upgrade https://github.com/douardda/radon/archive/main-module.zip
            python3 -m radon raw --json swh/ > reports/raw_report.json
            python3 -m radon cc  --json swh/ > reports/cc_report.json
            python3 -m radon mi  --json swh/ > reports/mi_report.json
            python3 -m radon hal --json swh/ > reports/hal_report.json
            python3 -m radon cc  --xml  swh/ > reports/cc_report.xml
            '''
          }}
        }}
        stage('Unit tests') {{
          steps {{
            sh  '''
if [ ! -f tox.ini ]
then cat >tox.ini <<EOF
[tox]
envlist=py3
[testenv:py3]
deps =
  pifpaf
  nose
  coverage
commands =
  pifpaf run postgresql -- nosetests {{posargs}}
EOF
fi
'''
            sh '''
            mkdir -p reports
            python3 -m tox -e py3 -- --with-coverage --cover-xml \
            --cover-xml-file=./reports/coverage.xml --cover-package=swh.${{modname}} \
            --cover-inclusive \
            --with-xunit --xunit-file=./reports/test-results.xml
            '''
          }}
          post {{
            always {{
              step([$class: 'CoberturaPublisher',
                    autoUpdateHealth: false,
                    autoUpdateStability: false,
                    coberturaReportFile: 'reports/coverage.xml',
                    failNoReports: false,
                    failUnhealthy: false,
                    failUnstable: false,
                    maxNumberOfBuilds: 10,
                    onlyStable: false,
                    sourceEncoding: 'ASCII',
                    zoomCoverageChart: false])
              junit allowEmptyResults: true, testResults: 'reports/test-results.xml'
              // disabled for now, reauires the plugin Warning v5 (still in RC)
              //recordIssues enabledForFailure: true, tools: [[pattern: '**/reports/cc_report.xml', tool: [$class: 'Ccm']]]
            }}
          }}
        }}
      }}
      }}

- job-group:
    name: '{name}-tests'
    jobs:
      - '{name}-unit-tests':
          isay: 'hello'

- project:
    name: project-name
    jobs:
    - '{name}-tests'
