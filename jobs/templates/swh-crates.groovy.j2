// Name of the crate is declared in the rust-packages.yaml per package
def crate_name = '{{crate_name}}'

// Whether we'll be able to publish or not
def publish_ok = false

pipeline {
  {% filter indent(width=2) %}
    {%- include 'includes/agent-docker.groovy.j2' -%}
  {% endfilter %}

  stages {
    stage('Run tests') {
      when {
        expression { return !params.SKIP_TESTS }
        beforeAgent true
      }
      agent none
      steps {
        build(
          job: '/{{name}}/gitlab-builds',
          parameters: [
            string(name: 'REVISION', value: params.GIT_TAG),
          ],
          propagate: !params.IGNORE_TESTS,
        )
      }
    }

    stage('Checkout') {
      steps {
        checkout([
          $class: 'GitSCM',
          userRemoteConfigs: [[
            name:'origin', url: '{{gitlab_url}}/{{gitlab_project_name}}.git',
            refspec: '+refs/tags/*:refs/remotes/origin/tags*'
          ]],
          branches: [[
            name: "${params.GIT_TAG}"
          ]],
          extensions: [[$class: 'CloneOption', honorRefspec: true]],
          doGenerateSubmoduleConfigurations: false,
          extensions: [],
          gitTool: 'Default',
          submoduleCfg: [],
        ])
      }
    }

    stage('(DryRun) Publish - Checks cargo package step is ok') {
      when {
        expression {
          LASTV=sh(returnStdout: true,
                   script:"cargo publish -p ${crate_name} --dry-run | awk '/Uploading/{print $3}'").trim()
          return LASTV != params.GIT_TAG
        }
      }
      steps {
         // It's fine to publish
         publish_ok = true
      }
    }

    stage('Publish') {
      when {
        // The dry-run publish is ok (meaning the package is crates compliant)
        expression { return publish_ok }
        // and we are running in dry-run mode
        expression { return not params.DRY_RUN }
      }
      steps {
        // Then we are go to publish the crates
        withCredentials([
          string(credentialsId: 'swhmirror-crates-api-token',
                 variable: 'CARGO_REGISTRY_TOKEN')]) {
          sh "cargo publish -p ${crate_name}"
        }
      }
    }
  }
  post {
    cleanup {
      cleanWs()
    }
  }
}
