- job-template:
    name: swh-{name}/metrics
    node: swh-tox

    parameters:
      - string:
          name: BRANCH
          default: '{branch|master}'
    scm:
      - git:
          refspec: 'refs/heads/{branch|master}'
          url: https://forge.softwareheritage.org/source/swh-{name}.git

    numToKeep: 20

    triggers:
      - pollscm:
          cron: "H */3 * * *"

    wrappers:
      - timestamps

    builders:
      - shell: |
          if [ ! -f tox.ini ]
          then cat >tox.ini <<EOF
          [tox]
          envlist=flake8
          [testenv:flake8]
          deps =
            flake8
          commands =
            {{envpython}} -m flake8 {{posargs}}
          EOF
          fi
      - shell: mkdir -p reports
      - shell: python3 -m tox -e flake8

      - shell: python3 -m radon raw --json swh/ > reports/radon_raw.json
      - shell: python3 -m radon cc --json swh/ > reports/radon_cc.json
      - shell: python3 -m radon mi --json swh/ > reports/radon_mi.json
