- job-template:
    name: '{name}/tox'
    node: swh-tox
    auth-token: ph4br1cat0r
    parameters:
      - string:
          name: REPO
          description: PHID of the Diffusion repository
      - string:
          name: PHID
          description: PHID of the Target object
      - string:
          name: COMMIT
          description: commit ID to test, if any
      - string:
          name: DIFF_ID
          description: ID of the Diff patch to apply, if any
    scm:
      - git:
          url: https://forge.softwareheritage.org/source/{display-name}.git

    wrappers:
      - phabricator-differential


    builders:
      - shell: |
          echo "Run tox for:"
          echo "  REPO=$REPO"
          echo "  PHID=$PHID"
          echo "  COMMIT=$COMMIT"
          echo "  DIFF_ID=$DIFF_ID"
      - shell: |
          if [ -n "$COMMIT" ]; then
          echo "Checkout commit $COMMIT"
          git checkout $COMMIT
          fi
      - shell: python3 -m tox --result-json tox-results.json

    publishers:
      - archive:
          artifacts: "*.json,.coverage"
      - phabricator:
          uberalls-enabled: false
          comment-with-console-link-on-failure: false
