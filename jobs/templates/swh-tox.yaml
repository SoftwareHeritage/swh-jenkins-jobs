- job-template:
    name: '{name}/tox'
    display-name: 'Phab. Diff'
    docker-image: swh-tox
    node: "{docker-image}"
    default-tox-environment: py3
    auth-token: ph4br1cat0r
    parameters:
      - string:
          name: REPO
          description: PHID of the Diffusion repository
      - string:
          name: PHID
          description: PHID of the Target object
      - string:
          name: DIFF_ID
          description: ID of the Diff patch to apply, if any
      - string:
          name: TOX_ENVIRONMENT
          description: tox environment to use for the main tox run
          default: "{default-tox-environment}"
    scm:
      - git:
          url: https://forge.softwareheritage.org/source/{display-name}.git
          branches:
            - origin/master

    wrappers:
      - phabricator-differential:
          apply-to-master: true
          patch-with-force-flag: true


    builders:
      - shell: |
          echo "Run tox for:"
          echo "  REPO=$REPO"
          echo "  PHID=$PHID"
          echo "  DIFF_ID=$DIFF_ID"
      - shell: |
          if (python3 -m tox -a | grep -qx flake8-phab ); then
              python3 -m tox -e flake8-phab
          else
              python3 -m tox -e flake8
          fi
      - shell: python3 -m tox --result-json tox-results.json -e $TOX_ENVIRONMENT

    publishers:
      - phabricator:
          uberalls-enabled: false
          comment-on-success: true
          comment-with-console-link-on-failure: true
          process-lint: true
          lint-file: .phabricator-lint
          lint-file-size: 1000000
      - archive:
          artifacts: "*.json,.coverage*,.phabricator*"
