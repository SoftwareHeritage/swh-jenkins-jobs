# we need a job-template to substitute gitlab_* variables
- job-template:
    name: jenkins-tools/{dockerfiles_job_name}
    gitlab_project_name: swh/infra/ci-cd/swh-jenkins-dockerfiles
    node: built-in
    scm:
      - git:
          url: "{gitlab_url}/{gitlab_project_name}.git"
          refspec: +refs/heads/*:refs/remotes/origin/*
            +refs/merge-requests/*/head:refs/remotes/origin/merge-requests/*
          branches:
            - origin/master
            - origin/merge-requests/${{gitlabMergeRequestIid}}
          wipe-workspace: false
    properties:
      - build-discarder:
          days-to-keep: 7
      - gitlab:
          connection: "{gitlab_connection_name}"
    triggers:
      - pollscm:
          cron: "H/30 * * * *"
      - timed: "@daily"
      - gitlab:
          trigger-push: true
          trigger-merge-request: true
          add-ci-message: true
          cancel-pending-builds-on-update: true
          # secret jenkins token is generated when executing tox
          secret-token: !include-raw: jobs/templates/jenkins-token
    wrappers:
      - timestamps
      - ansicolor
    builders:
      - shell: |
          #!/bin/bash
          export REGISTRY=swh-jenkins-test
          if [[ "$gitlabActionType" == "" ]] || \
            [[ "$gitlabActionType" == "PUSH" && "$gitlabBranch" == "master" ]]
          then
            export REGISTRY=swh-jenkins
          fi
          make checkrebuild all
    publishers:
      - gitlab-notifier

- project:
    name: swh-jenkins-dockerfiles
    dockerfiles_job_name: "{name}"
    jobs:
      - "jenkins-tools/{dockerfiles_job_name}"
